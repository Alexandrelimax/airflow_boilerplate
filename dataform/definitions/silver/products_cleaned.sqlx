config {
  type: "incremental",
  schema: "silver",
  uniqueKey: "product_id"
}

WITH ranked_products AS (
  SELECT *,
    ROW_NUMBER() OVER (PARTITION BY product_id ORDER BY updated_at DESC) AS rn
  FROM ${ref("bronze.products_raw")}
)

SELECT
  product_id,
  INITCAP(product_name) AS product_name,
  category,
  price,
  updated_at
FROM ranked_products
WHERE rn = 1
